Return-Path: <linux-arm-kernel-bounces+lists+linux-arm-kernel=lfdr.de@lists.infradead.org>
X-Original-To: lists+linux-arm-kernel@lfdr.de
Delivered-To: lists+linux-arm-kernel@lfdr.de
Received: from bombadil.infradead.org (bombadil.infradead.org [IPv6:2607:7c80:54:e::133])
	by mail.lfdr.de (Postfix) with ESMTPS id 34A1A128D8D
	for <lists+linux-arm-kernel@lfdr.de>; Sun, 22 Dec 2019 12:24:36 +0100 (CET)
DKIM-Signature: v=1; a=rsa-sha256; q=dns/txt; c=relaxed/relaxed;
	d=lists.infradead.org; s=bombadil.20170209; h=Sender:
	Content-Transfer-Encoding:Content-Type:Cc:List-Subscribe:List-Help:List-Post:
	List-Archive:List-Unsubscribe:List-Id:MIME-Version:References:In-Reply-To:
	Subject:To:From:Message-ID:Date:Reply-To:Content-ID:Content-Description:
	Resent-Date:Resent-From:Resent-Sender:Resent-To:Resent-Cc:Resent-Message-ID:
	List-Owner; bh=1v+5/MdXE0ktjaUsqvId8qI9UaHdSr4wQyj1AivHQFI=; b=NqQxHVQ6/SY67i
	Xm910lDBwDSKkebWKxFWwswSkkEvCvnKEPSKYnfDkuiPfK5Cgji1x77/1vHF15fc1pm8CIA1XMrPh
	OScuKg3X3mq9LAg+BH4Lxt7CjIHai1rDx3alG/S8qXoTGinalFSMXKMCEvpd1g5nzYvfB7x7LOBdB
	VPEsSZ8dyky6Ifq1QL+y9S15rS3UDPVp+2HT192LC4hQEoXJyJbS1e+1aiT2iepdxgvFyMxpc76o2
	wQdNNJWESTMJ8zIqgghTStB/qjdFJuTNRpwjx6HxAmhf2FaWRfiDxjqCN00PECFB2UFWLPj87lRvc
	j68gyGJh1Q12AJfaA+sA==;
Received: from localhost ([127.0.0.1] helo=bombadil.infradead.org)
	by bombadil.infradead.org with esmtp (Exim 4.92.3 #3 (Red Hat Linux))
	id 1iizLc-0007Au-K2; Sun, 22 Dec 2019 11:24:32 +0000
Received: from inca-roads.misterjones.org ([213.251.177.50])
 by bombadil.infradead.org with esmtps (Exim 4.92.3 #3 (Red Hat Linux))
 id 1iizLS-0007AQ-88
 for linux-arm-kernel@lists.infradead.org; Sun, 22 Dec 2019 11:24:23 +0000
Received: from 78.163-31-62.static.virginmediabusiness.co.uk ([62.31.163.78]
 helo=big-swifty.misterjones.org)
 by cheepnis.misterjones.org with esmtpsa (TLSv1.2:AES256-GCM-SHA384:256)
 (Exim 4.80) (envelope-from <maz@kernel.org>)
 id 1iizLM-0006ag-LE; Sun, 22 Dec 2019 12:24:17 +0100
Date: Sun, 22 Dec 2019 11:24:13 +0000
Message-ID: <868sn4iowy.wl-maz@kernel.org>
From: Marc Zyngier <maz@kernel.org>
To: Andrew Murray <andrew.murray@arm.com>
Subject: Re: [PATCH v2 13/18] perf: arm_spe: Add KVM structure for obtaining
 IRQ info
In-Reply-To: <20191220143025.33853-14-andrew.murray@arm.com>
References: <20191220143025.33853-1-andrew.murray@arm.com>
 <20191220143025.33853-14-andrew.murray@arm.com>
User-Agent: Wanderlust/2.15.9 (Almost Unreal) SEMI-EPG/1.14.7 (Harue)
 FLIM/1.14.9 (=?UTF-8?B?R29qxY0=?=) APEL/10.8 EasyPG/1.0.0 Emacs/26
 (aarch64-unknown-linux-gnu) MULE/6.0 (HANACHIRUSATO)
MIME-Version: 1.0 (generated by SEMI-EPG 1.14.7 - "Harue")
X-SA-Exim-Connect-IP: 62.31.163.78
X-SA-Exim-Rcpt-To: andrew.murray@arm.com, catalin.marinas@arm.com,
 will@kernel.org, kvm@vger.kernel.org, linux-kernel@vger.kernel.org,
 sudeep.holla@arm.com, kvmarm@lists.cs.columbia.edu,
 linux-arm-kernel@lists.infradead.org
X-SA-Exim-Mail-From: maz@kernel.org
X-SA-Exim-Scanned: No (on cheepnis.misterjones.org);
 SAEximRunCond expanded to false
X-CRM114-Version: 20100106-BlameMichelson ( TRE 0.8.0 (BSD) ) MR-646709E3 
X-CRM114-CacheID: sfid-20191222_032422_433758_44A36706 
X-CRM114-Status: GOOD (  18.48  )
X-Spam-Score: 1.0 (+)
X-Spam-Report: SpamAssassin version 3.4.2 on bombadil.infradead.org summary:
 Content analysis details:   (1.0 points)
 pts rule name              description
 ---- ---------------------- --------------------------------------------------
 1.0 SPF_SOFTFAIL           SPF: sender does not match SPF record (softfail)
 0.0 SPF_HELO_NONE          SPF: HELO does not publish an SPF Record
X-BeenThere: linux-arm-kernel@lists.infradead.org
X-Mailman-Version: 2.1.29
Precedence: list
List-Id: <linux-arm-kernel.lists.infradead.org>
List-Unsubscribe: <http://lists.infradead.org/mailman/options/linux-arm-kernel>, 
 <mailto:linux-arm-kernel-request@lists.infradead.org?subject=unsubscribe>
List-Archive: <http://lists.infradead.org/pipermail/linux-arm-kernel/>
List-Post: <mailto:linux-arm-kernel@lists.infradead.org>
List-Help: <mailto:linux-arm-kernel-request@lists.infradead.org?subject=help>
List-Subscribe: <http://lists.infradead.org/mailman/listinfo/linux-arm-kernel>, 
 <mailto:linux-arm-kernel-request@lists.infradead.org?subject=subscribe>
Cc: kvm@vger.kernel.org, Catalin Marinas <catalin.marinas@arm.com>,
 linux-kernel@vger.kernel.org, Sudeep Holla <sudeep.holla@arm.com>,
 Will Deacon <will@kernel.org>, kvmarm@lists.cs.columbia.edu,
 linux-arm-kernel@lists.infradead.org
Content-Type: text/plain; charset="us-ascii"
Content-Transfer-Encoding: 7bit
Sender: "linux-arm-kernel" <linux-arm-kernel-bounces@lists.infradead.org>
Errors-To: linux-arm-kernel-bounces+lists+linux-arm-kernel=lfdr.de@lists.infradead.org

On Fri, 20 Dec 2019 14:30:20 +0000,
Andrew Murray <andrew.murray@arm.com> wrote:
> 
> KVM requires knowledge of the physical SPE IRQ number such that it can
> associate it with any virtual IRQ for guests that require SPE emulation.

This is at best extremely odd. The only reason for KVM to obtain this
IRQ number is if it has exclusive access to the device.  This
obviously isn't the case, as this device is shared between host and
guest.

> Let's create a structure to hold this information and an accessor that
> KVM can use to retrieve this information.
> 
> We expect that each SPE device will have the same physical PPI number
> and thus will warn when this is not the case.
> 
> Signed-off-by: Andrew Murray <andrew.murray@arm.com>
> ---
>  drivers/perf/arm_spe_pmu.c | 23 +++++++++++++++++++++++
>  include/kvm/arm_spe.h      |  6 ++++++
>  2 files changed, 29 insertions(+)
> 
> diff --git a/drivers/perf/arm_spe_pmu.c b/drivers/perf/arm_spe_pmu.c
> index 4e4984a55cd1..2d24af4cfcab 100644
> --- a/drivers/perf/arm_spe_pmu.c
> +++ b/drivers/perf/arm_spe_pmu.c
> @@ -34,6 +34,9 @@
>  #include <linux/smp.h>
>  #include <linux/vmalloc.h>
>  
> +#include <linux/kvm_host.h>
> +#include <kvm/arm_spe.h>
> +
>  #include <asm/barrier.h>
>  #include <asm/cpufeature.h>
>  #include <asm/mmu.h>
> @@ -1127,6 +1130,24 @@ static void arm_spe_pmu_dev_teardown(struct arm_spe_pmu *spe_pmu)
>  	free_percpu_irq(spe_pmu->irq, spe_pmu->handle);
>  }
>  
> +#ifdef CONFIG_KVM_ARM_SPE
> +static struct arm_spe_kvm_info arm_spe_kvm_info;
> +
> +struct arm_spe_kvm_info *arm_spe_get_kvm_info(void)
> +{
> +	return &arm_spe_kvm_info;
> +}

How does this work when SPE is built as a module?

> +
> +static void arm_spe_populate_kvm_info(struct arm_spe_pmu *spe_pmu)
> +{
> +	WARN_ON_ONCE(arm_spe_kvm_info.physical_irq != 0 &&
> +		     arm_spe_kvm_info.physical_irq != spe_pmu->irq);
> +	arm_spe_kvm_info.physical_irq = spe_pmu->irq;

What does 'physical' means here? It's an IRQ in the Linux sense, so
it's already some random number that bears no relation to anything
'physical'.

> +}
> +#else
> +static void arm_spe_populate_kvm_info(struct arm_spe_pmu *spe_pmu) {}
> +#endif
> +
>  /* Driver and device probing */
>  static int arm_spe_pmu_irq_probe(struct arm_spe_pmu *spe_pmu)
>  {
> @@ -1149,6 +1170,8 @@ static int arm_spe_pmu_irq_probe(struct arm_spe_pmu *spe_pmu)
>  	}
>  
>  	spe_pmu->irq = irq;
> +	arm_spe_populate_kvm_info(spe_pmu);
> +
>  	return 0;
>  }
>  
> diff --git a/include/kvm/arm_spe.h b/include/kvm/arm_spe.h
> index d1f3c564dfd0..9c65130d726d 100644
> --- a/include/kvm/arm_spe.h
> +++ b/include/kvm/arm_spe.h
> @@ -17,6 +17,12 @@ struct kvm_spe {
>  	bool irq_level;
>  };
>  
> +struct arm_spe_kvm_info {
> +	int physical_irq;
> +};
> +
> +struct arm_spe_kvm_info *arm_spe_get_kvm_info(void);
> +
>  #ifdef CONFIG_KVM_ARM_SPE
>  #define kvm_arm_spe_v1_ready(v)		((v)->arch.spe.ready)
>  #define kvm_arm_spe_irq_initialized(v)		\

	M.

-- 
Jazz is not dead, it just smells funny.

_______________________________________________
linux-arm-kernel mailing list
linux-arm-kernel@lists.infradead.org
http://lists.infradead.org/mailman/listinfo/linux-arm-kernel
